<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DMZ Simulator</title>
  <link rel='stylesheet' href="{{ url_for('static', filename='minesweeper.css') }}">
</head>

<body>
    <h1>Sweep Them Mines Boy</h1>
    <div class='legend'>Leftâ€‘click: reveal â€¢ Rightâ€‘click: ðŸš©</div>
    <div class='wrap'>
        <div class='controls'>
            <span id='nflags-base' class='counter'><span id='nflags'> </span></span>
            <button id='reset'>ðŸ™‚</button>
            <span id='timer-base' class='counter'><span id='timer'> </span></span>
        </div>
        <div id='grid' class='grid'></div>
    </div>
    <div class='scores'>
        <span id='score-base'>Score: <span id='score'> </span></span>
        <span id='hscore-base'>Best: <span id='hscore'> </span></span>
    </div>

    <script>
        // game vars
        const gap_size = 4 // px
        let game_over = true
        let nflags = 0

        // timer vars
        const max_time = 999 // secs
        let elapsed_t = 0
        let timer_id = null

        // --------------------- game logic --------------------------
        async function init() {
            const r = await fetch('/minesweeper/init', {method: 'GET'})
            const data = await r.json()
            document.getElementById('hscore').textContent = `${data.hscore}`
            document.getElementById('score').textContent = '0'
            document.getElementById('nflags').textContent = `${data.nflags}`
            document.getElementById('timer').textContent = String(0).padStart(3, '0')
            document.getElementById('reset').textContent = 'ðŸ™‚'
            await create_grid(data.ndim)
        }
        
        async function create_grid(n) {
            // update CSS variables for layout
            const grid = document.getElementById('grid')
            grid.style.setProperty('--cols', n)
            grid.style.setProperty('--size', n)
            grid.style.setProperty('--gap', gap_size + 'px')
            grid.innerHTML = ''
            // fill grid w/ buttons 
            for (let r = 0; r < n; r++) {
                for (let c = 0; c < n; c++) {
                    const tile = document.createElement('button')
                    tile.className = 'tile'
                    tile.dataset.row = r
                    tile.dataset.col = c
                    
                    // show coordinates on middle-click (auxclick)
                    tile.title = `(${r}, ${c})`
                    
                    // left click: reveal
                    tile.addEventListener('click', async (e) => {
                        e.preventDefault()
                        await reveal_tiles(tile)
                    });
                    // right click: flag
                    tile.addEventListener('contextmenu', async (e) => {
                        e.preventDefault()
                        await toggle_flag(tile)
                    });
                    
                    grid.appendChild(tile)
                }
            }
        }

        async function reset() {
            await init()
            reset_timer()
            game_over = true
        }
        
        function start(i, j) {
            fetch('/minesweeper/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({choice: [i,j]})
            })
            start_timer()
        }
        
        async function verify(i, j) {
            const r = await fetch('/minesweeper/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({choice: [i,j]})
            })
            const data = await r.json()
            
            if (data.status == 'flagged') return
            if (data.status == 'game_over') {
                game_over = true
                stop_timer()
                let score = reveal_mines(data.mines)
                update(score) 
                document.getElementById('score').textContent = `${score}`
                document.getElementById('reset').textContent = 'ðŸ˜µ'
                return
            }
            if (data.status == 'won') {
                game_over = true
                stop_timer()
                update(data.score) 
                document.getElementById('score').textContent = `${data.score}`
                document.getElementById('reset').textContent = 'ðŸ˜Ž'
                return data.revealed
            }
            return data.revealed
        }
        

        async function reveal_tiles(tile) {
            const i = Number(tile.dataset.row)
            const j = Number(tile.dataset.col)
           
            // start tile is always safe
            if (game_over) {
                game_over = false
                await start(i, j)
            }
            // tiles to reveal
            // excludes tiles already revealed or flagged
            const revealed = await verify(i, j)
            // only true if flagged or game over
            if (revealed == null) return
            revealed.forEach(t_info => {
                const t = document.querySelector(`.tile[data-row="${t_info.r}"][data-col="${t_info.c}"]`)
                reveal_tile(t, Number(t_info.num))
            })
        }
        
        function reveal_tile(tile, num) {
            // do nothing if already revealed or flagged
            if (tile.classList.contains('reveal') || tile.classList.contains('flag')) return
            tile.classList.add('reveal')
            // only show num if non-empty tile
            tile.textContent = num === 0 ? '' : num
            // assign preset colour to num
            if (num > 0) tile.classList.add('num'+num)
        }
        
        function reveal_mines(mines) {
            let score = 0
            mines.forEach(tile => {
                const mine = document.querySelector(`.tile[data-row="${tile[0]}"][data-col="${tile[1]}"]`)
                // if mine correctly flagged, +1 score
                // flag is already toggled
                if (mine.classList.contains('flag')) 
                    score++
                else 
                    mine.textContent = 'ðŸ’£'
                mine.classList.add('reveal')
            })
            return score
        }
        
        async function toggle_flag(tile) {
            // cant flag a revealed tile 
            if (tile.classList.contains('reveal')) return
            // ensure indices are ints
            const i = Number(tile.dataset.row)
            const j = Number(tile.dataset.col)
            const r = await fetch('/minesweeper/flag', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tile: [i, j]})
            })
            const data = await r.json()
            
            // only true if nflags = 0
            if (!data.toggle) return
            tile.classList.toggle('flag')
            document.getElementById('nflags').textContent = `${data.nflags}`
        }

        function update(score) {
            fetch('/minesweeper/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({score: score})
            })
        }
        
        // --------------------- timer ------------------------
        function start_timer() {
            // no dupes
            if (timer_id) return
            // incr elapsed time every 1000ms == 1s
            timer_id = setInterval(() => {
                elapsed_t++
                document.getElementById('timer').textContent = String(elapsed_t).padStart(3, '0')
                if (elapsed_t >= max_time) 
                    stop_timer()
            }, 1000)
        }

        function stop_timer() {
            if (!timer_id) return
            clearInterval(timer_id);
            timer_id = null
        }

        function reset_timer() {
            stop_timer()
            elapsed_t = 0
        }
        
        // ------------------------ init -------------------------------
        window.onload = async function() {
            await init()
        }

        document.getElementById('reset').addEventListener('click', async () => {
            await reset()
        })
    </script>
</body>
</html>
