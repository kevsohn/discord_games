<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minesweeper</title>
  <style>
    :root {
      --tile: 40px;         /* base tile size (fallback if aspect-ratio unsupported) */
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --accent: #22c55e;    /* green-500 */
      --tile-bg: #1f2937;   /* gray-800 */
      --tile-hover: #374151;/* gray-700 */
      --tile-reveal: #111827; /* gray-900 */
      --tile-border: #111827;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 800px at 20% 10%, #0b1220, var(--bg));
      color: #e5e7eb;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .wrap {
      max-width: 920px;
      margin: 32px auto;
      padding: 16px;
    }

    h1 {
      font-weight: 700;
      letter-spacing: 0.2px;
      margin: 0 0 12px;
    }

    .controls {
      background: var(--panel);
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 10px 30px rgb(0 0 0 / 0.25);
    }

    .controls label {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #334155;
      background: linear-gradient(180deg, #1f2937, #0b1220);
      color: #e5e7eb;
      cursor: pointer;
      transition: transform 120ms ease, background 120ms ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: scale(0.9); }

    .grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      gap: var(--gap);
      user-select: none;
    }

    .tile {
      position: relative;
      display: inline-grid;
      place-items: center;
      width: 100%;
      aspect-ratio: 1 / 1;  /* keeps perfect squares in modern browsers */
      /* Fallback for very old browsers: fixed height */
      height: var(--tile);
      width: var(--tile);
      background: var(--tile-bg);
      border: 1px solid var(--tile-border);
      border-radius: 8px;
      font-weight: 700;
      font-size: 16px;
      color: #e5e7eb;
      cursor: pointer;
      outline: none;
      transition: background 120ms ease, transform 60ms ease;
    }
    .tile:hover { background: var(--tile-hover); }
    .tile:active { transform: translateY(1px); }

    /* controls */
    .tile.reveal { background: var(--tile-reveal); cursor: default; }
    .tile.flag::after {
      content: "üö©";
      font-size: 16px;
    }

    /* number coloring like the OG */
    .num1 { color: #60a5fa; } /* blue-400 */
    .num2 { color: #34d399; } /* emerald-400 */
    .num3 { color: #f87171; } /* red-400 */
    .num4 { color: #a78bfa; } /* violet-400 */
    .num5 { color: #fbbf24; } /* amber-400 */
    .num6 { color: #22d3ee; } /* cyanum-400 */
    .num7 { color: #f472b6; } /* pinumk-400 */
    .num8 { color: #9ca3af; } /* gray-400 */

    .legend { font-size: 13px; opacity: 0.8; margin-top: 10px; }
    .legend kbd { background:#0b1220; border:1px solid #334155; border-bottom-width:2px; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
    <div class="wrap">
        <h1>Sweep them Mines Boy (DMZ Simulator)</h1>

        <div class="controls">
            <div id='hscore'>High Score: </div>
            <div id='score'>Score: </div>
            <div id='nflags'>üö© </div>
            <div id='timer'>‚è±Ô∏è </div>
            <button id='reset' class='btn'>üôÇ</button>
            <span style="flex:1"></span>
            <span class="legend">Left‚Äëclick: reveal ‚Ä¢ Right‚Äëclick: flag</span>
        </div>

        <div id="grid" class="grid"></div>
    </div>

    <script>
        // game vars
        const gap_size = 4 // px
        let game_over = true
        let nflags = 0

        // timer vars
        const max_time = 999 // secs
        let elapsed_t = 0
        let timer_id = null

        // --------------------- game logic --------------------------
        async function init() {
            const r = await fetch('/minesweeper/init', {method: 'GET'})
            const data = await r.json()
            document.getElementById('hscore').textContent = `High Score: ${data.hscore}`
            document.getElementById('score').textContent = 'Score: 0'
            document.getElementById('nflags').textContent = `üö© ${data.nflags}`
            document.getElementById('timer').textContent = '‚è±Ô∏è '+String(0).padStart(3, '0')
            document.getElementById('reset').textContent = 'üôÇ'
            await create_grid(data.ndim)
        }
        
        async function create_grid(n) {
            // update CSS variables for layout
            const grid = document.getElementById('grid')
            grid.style.setProperty('--cols', n)
            grid.style.setProperty('--size', n)
            grid.style.setProperty('--gap', gap_size + 'px')
            grid.innerHTML = ''
            // fill grid w/ buttons 
            for (let r = 0; r < n; r++) {
                for (let c = 0; c < n; c++) {
                    const tile = document.createElement('button')
                    tile.className = 'tile'
                    tile.dataset.row = r
                    tile.dataset.col = c
                    
                    // show coordinates on middle-click (auxclick)
                    tile.title = `(${r}, ${c})`
                    
                    // left click: reveal
                    tile.addEventListener('click', async (e) => {
                        e.preventDefault()
                        await reveal_tiles(tile)
                    });
                    // right click: flag
                    tile.addEventListener('contextmenu', async (e) => {
                        e.preventDefault()
                        await toggle_flag(tile)
                    });
                    
                    grid.appendChild(tile)
                }
            }
        }
        
        async function start(i, j) {
            await init()
            fetch('/minesweeper/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({choice: [i,j]})
            })
            reset_timer()
            start_timer()
        }
        
        async function verify(i, j) {
            const r = await fetch('/minesweeper/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({choice: [i,j]})
            })
            const data = await r.json()
            
            if (data.status == 'flagged') return
            if (data.status == 'game_over') {
                game_over = true
                stop_timer()
                let score = reveal_mines(data.mines)
                update(score) 
                document.getElementById('score').textContent = `Score: ${score}`
                document.getElementById('reset').textContent = 'üòµ'
                return
            }
            if (data.status == 'won') {
                game_over = true
                stop_timer()
                update(data.score) 
                document.getElementById('score').textContent = `Score: ${data.score}`
                document.getElementById('reset').textContent = 'üòé'
                return data.revealed
            }
            return data.revealed
        }
        
        function reveal_mines(mines) {
            let score = 0
            mines.forEach(tile => {
                const mine = document.querySelector(`.tile[data-row="${tile[0]}"][data-col="${tile[1]}"]`)
                // if mine correctly flagged, +1 score
                // flag is already toggled
                if (mine.classList.contains('flag')) 
                    score++
                else 
                    mine.textContent = 'üí£'
                mine.classList.add('reveal')
            })
            return score
        }

        async function reveal_tiles(tile) {
            const i = Number(tile.dataset.row)
            const j = Number(tile.dataset.col)
           
            // start tile is always safe
            if (game_over) {
                game_over = false
                await start(i, j)
            }
            // tiles to reveal
            // excludes tiles already revealed or flagged
            const revealed = await verify(i, j)
            // only true if flagged or game over
            if (revealed == null) return
            revealed.forEach(t_info => {
                const t = document.querySelector(`.tile[data-row="${t_info.r}"][data-col="${t_info.c}"]`)
                reveal_tile(t, Number(t_info.num))
            })
        }
        
        function reveal_tile(tile, num) {
            // do nothing if already revealed or flagged
            if (tile.classList.contains('reveal') || tile.classList.contains('flag')) return
            tile.classList.add('reveal')
            // only show num if non-empty tile
            tile.textContent = num === 0 ? '' : num
            // assign preset colour to num
            if (num > 0) tile.classList.add('num'+num)
        }
        
        async function toggle_flag(tile) {
            // cant flag a revealed tile 
            if (tile.classList.contains('reveal')) return
            // ensure indices are ints
            const i = Number(tile.dataset.row)
            const j = Number(tile.dataset.col)
            const r = await fetch('/minesweeper/flag', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tile: [i, j]})
            })
            const data = await r.json()
            
            // only true if nflags = 0
            if (!data.toggle) return
            tile.classList.toggle('flag')
            document.getElementById('nflags').textContent = `üö© ${data.nflags}`
        }

        function update(score) {
            fetch('/minesweeper/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({score: score})
            })
        }
        
        // --------------------- timer ------------------------
        function start_timer() {
            // no dupes
            if (timer_id) return
            // incr elapsed time every 1000ms == 1s
            timer_id = setInterval(() => {
                elapsed_t++
                document.getElementById('timer').textContent = '‚è±Ô∏è '+String(elapsed_t).padStart(3, '0')
                if (elapsed_t >= max_time) stop_timer()
            }, 1000)
        }

        function stop_timer() {
            if (!timer_id) return
            clearInterval(timer_id);
            timer_id = null
        }

        function reset_timer() {
            stop_timer()
            elapsed_t = 0
        }
        
        // ------------------------ init -------------------------------
        window.onload = async function() {
            await init()
        }

        document.getElementById('reset').addEventListener('click', async () => {
            await init()
        })
    </script>
</body>
</html>
